---
description: 
globs: 
alwaysApply: false
---
# üß™ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é –±—ç–∫–µ–Ω–¥–∞ (Django + pytest)

**–¶–µ–ª—å:** –û–±–µ—Å–ø–µ—á–∏—Ç—å –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç—å Django API –∏ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ —á–µ—Ä–µ–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ.

---

### 1. –§–∏–ª–æ—Å–æ—Ñ–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

1.  **–¢–µ—Å—Ç–∏—Ä—É–π API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã.** –í –ø–µ—Ä–≤—É—é –æ—á–µ—Ä–µ–¥—å —Ç–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ —Å—Ç–∞—Ç—É—Å-–∫–æ–¥—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö.
2.  **–¢–µ—Å—Ç–∏—Ä—É–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫—É.** –°–ª–æ–∂–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã, –º–æ–¥–µ–ª–∏ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º–∏ –º–µ—Ç–æ–¥–∞–º–∏, –≤–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö.
3.  **–ú–æ–∫–∞–π –≤–Ω–µ—à–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏.** Supabase JWT, email-—Å–µ—Ä–≤–∏—Å—ã, –≤–Ω–µ—à–Ω–∏–µ API - –≤—Å—ë –º–æ–∫–∞–µ—Ç—Å—è.

---

### 2. –ß—Ç–æ –º—ã —Ç–µ—Å—Ç–∏—Ä—É–µ–º?

| –¢–∏–ø —Ç–µ—Å—Ç–∞     | –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã       | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ–º                                                                        | –†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ                               |
|---------------|-------------------|--------------------------------------------------------------------------------------|--------------------------------------------|
| **Unit-—Ç–µ—Å—Ç—ã**  | `pytest`          | ‚Ä¢ –ú–æ–¥–µ–ª–∏ Django (–º–µ—Ç–æ–¥—ã, –≤–∞–ª–∏–¥–∞—Ü–∏—è) <br> ‚Ä¢ –°–µ—Ä–≤–∏—Å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ <br> ‚Ä¢ –°–µ–ª–µ–∫—Ç–æ—Ä—ã <br> ‚Ä¢ –°–µ—Ä–∏–∞–ª–∏–∑–∞—Ç–æ—Ä—ã | `backend/tests/test_<app_name>.py` |
| **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã** | `pytest-django`, `APIClient` | ‚Ä¢ API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (GET, POST, PUT, DELETE) <br> ‚Ä¢ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è <br> ‚Ä¢ –ü–æ–ª–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ | `backend/tests/test_<app_name>.py` |

### 3. –ß—Ç–æ –º—ã –ù–ï —Ç–µ—Å—Ç–∏—Ä—É–µ–º?

-   **Django ORM:** –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º, —á—Ç–æ `User.objects.filter()` —Ä–∞–±–æ—Ç–∞–µ—Ç. Django —É–∂–µ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–ª —ç—Ç–æ.
-   **–í–Ω–µ—à–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:** –ù–µ —Ç–µ—Å—Ç–∏—Ä—É–µ–º `requests`, `jwt`, `supabase-py`.
-   **–°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –∏ —à–∞–±–ª–æ–Ω—ã:** –£ –Ω–∞—Å SPA —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥, Django —Ç–æ–ª—å–∫–æ API.

---

### 4. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

```
backend/
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py
‚îÇ   ‚îú‚îÄ‚îÄ conftest.py          # –û–±—â–∏–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∫–ª–∏–µ–Ω—Ç—ã)
‚îÇ   ‚îú‚îÄ‚îÄ test_users.py        # –¢–µ—Å—Ç—ã –¥–ª—è users app
‚îÇ   ‚îú‚îÄ‚îÄ test_orders.py       # –¢–µ—Å—Ç—ã –¥–ª—è orders app
‚îÇ   ‚îî‚îÄ‚îÄ test_exchange.py     # –¢–µ—Å—Ç—ã –¥–ª—è exchange app
‚îî‚îÄ‚îÄ pytest.ini              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è pytest
```

### 5. –ö–∞–∫ –ø–∏—Å–∞—Ç—å —Ç–µ—Å—Ç—ã

#### –ü—Ä–∏–º–µ—Ä Unit-—Ç–µ—Å—Ç–∞ (–º–æ–¥–µ–ª—å):

```python
@pytest.mark.django_db
class TestUserModel:
    def test_user_full_name(self, user):
        # Arrange
        user.first_name = "–ò–≤–∞–Ω"
        user.last_name = "–ü–µ—Ç—Ä–æ–≤"
        
        # Act
        full_name = user.get_full_name()
        
        # Assert
        assert full_name == "–ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤"
```

#### –ü—Ä–∏–º–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞ (API):

```python
@pytest.mark.django_db
class TestOrderAPI:
    def test_create_order_authenticated(self, authenticated_api_client):
        # Arrange
        url = reverse('orders:create')
        data = {
            'from_currency': 'USD',
            'to_currency': 'RUB',
            'amount': 100
        }
        
        # Act
        response = authenticated_api_client.post(url, data)
        
        # Assert
        assert response.status_code == 201
        assert response.data['from_currency'] == 'USD'
```

### 6. –ü–æ–ª–µ–∑–Ω—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —Ñ–∏–∫—Å—Ç—É—Ä—ã –∏–∑ `conftest.py`:

- `api_client`: –ù–µ–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API –∫–ª–∏–µ–Ω—Ç
- `authenticated_api_client`: –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π API –∫–ª–∏–µ–Ω—Ç
- `user`: –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
- `mock_supabase_jwt`: –ú–æ–∫ –¥–ª—è JWT –≤–∞–ª–∏–¥–∞—Ü–∏–∏

### 7. –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤

-   `pytest`: –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
-   `pytest tests/test_users.py`: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã —Ç–æ–ª—å–∫–æ –¥–ª—è users
-   `pytest -m unit`: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–æ–ª—å–∫–æ unit-—Ç–µ—Å—Ç—ã
-   `pytest --cov`: –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å –æ—Ç—á–µ—Ç–æ–º –æ –ø–æ–∫—Ä—ã—Ç–∏–∏ –∫–æ–¥–∞
-   `pytest -v`: –ü–æ–¥—Ä–æ–±–Ω—ã–π –≤—ã–≤–æ–¥

### 8. –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞

- **–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥**: 80% –ø–æ–∫—Ä—ã—Ç–∏—è (–Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ –≤ `pytest.ini`)
- **HTML –æ—Ç—á–µ—Ç**: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –≤ `htmlcov/index.html`
- **–ò—Å–∫–ª—é—á–µ–Ω–∏—è**: –ú–∏–≥—Ä–∞—Ü–∏–∏, –Ω–∞—Å—Ç—Ä–æ–π–∫–∏, `__init__.py` —Ñ–∞–π–ª—ã

–≠—Ç–æ—Ç –ø–æ–¥—Ö–æ–¥ –ø–æ–º–æ–∂–µ—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –≤—ã—Å–æ–∫–æ–µ –∫–∞—á–µ—Å—Ç–≤–æ Django API –±–µ–∑ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏.
